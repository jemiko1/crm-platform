generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Building {
  id              String           @id @default(uuid())
  name            String
  address         String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  city            String?
  coreId          Int              @unique
  lastSyncedAt    DateTime?
  coreUpdatedAt   DateTime?
  coreCreatedAt   DateTime?
  isActive        Boolean          @default(true)
  deletedAt       DateTime?
  assets          Asset[]
  clientBuildings ClientBuilding[]
  incidents       Incident[]
  workOrders      WorkOrder[]

  @@index([name])
  @@index([city])
  @@index([isActive])
}

model Client {
  id              String           @id @default(uuid())
  coreId          Int              @unique
  firstName       String?
  lastName        String?
  idNumber        String?
  paymentId       String?
  primaryPhone    String?
  secondaryPhone  String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  lastSyncedAt    DateTime?
  coreUpdatedAt   DateTime?
  coreCreatedAt   DateTime?
  isActive        Boolean          @default(true)
  deletedAt       DateTime?
  clientBuildings      ClientBuilding[]
  incidents            Incident[]
  chatConversations    ClientChatConversation[] @relation("ClientChatConversations")
  chatParticipants     ClientChatParticipant[]  @relation("ClientChatParticipants")

  @@index([primaryPhone])
  @@index([idNumber])
  @@index([isActive])
}

model ClientBuilding {
  clientId   String
  buildingId String
  createdAt  DateTime @default(now())
  building   Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@id([clientId, buildingId])
  @@index([buildingId])
  @@index([clientId])
}

model Asset {
  id              String           @id @default(uuid())
  buildingId      String
  type            String
  name            String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  coreId          Int              @unique
  ip              String?
  status          DeviceStatus     @default(UNKNOWN)
  lastSyncedAt    DateTime?
  coreUpdatedAt   DateTime?
  coreCreatedAt   DateTime?
  isActive        Boolean          @default(true)
  deletedAt       DateTime?
  building        Building         @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  incidentAssets  IncidentAsset[]
  workOrders      WorkOrder[]
  workOrderAssets WorkOrderAsset[]

  @@index([buildingId])
  @@index([type])
  @@index([status])
  @@index([isActive])
}

model WorkOrder {
  id                      String                  @id @default(uuid())
  buildingId              String
  assetId                 String?
  status                  WorkOrderStatus         @default(CREATED)
  title                   String
  notes                   String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  parentWorkOrderId       String?
  contactNumber           String?
  deadline                DateTime?
  amountGel               Decimal?                @db.Decimal(10, 2)
  inventoryProcessingType String?
  techEmployeeComment     String?
  techHeadComment         String?
  cancelReason            String?
  startedAt               DateTime?
  completedAt             DateTime?
  canceledAt              DateTime?
  workOrderNumber         Int                     @unique @default(autoincrement())
  type                    WorkOrderType
  deactivatedDevices      DeactivatedDevice[]
  asset                   Asset?                  @relation(fields: [assetId], references: [id])
  building                Building                @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  parentWorkOrder         WorkOrder?              @relation("WorkOrderSubOrders", fields: [parentWorkOrderId], references: [id])
  childWorkOrders         WorkOrder[]             @relation("WorkOrderSubOrders")
  activityLogs            WorkOrderActivityLog[]
  workOrderAssets         WorkOrderAsset[]
  assignments             WorkOrderAssignment[]
  notifications           WorkOrderNotification[]
  productUsages           WorkOrderProductUsage[]

  @@index([buildingId])
  @@index([assetId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([parentWorkOrderId])
  @@index([workOrderNumber])
}

model WorkOrderAssignment {
  id          String    @id @default(uuid())
  workOrderId String
  employeeId  String
  assignedAt  DateTime  @default(now())
  assignedBy  String?
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([employeeId])
}

model WorkOrderAsset {
  workOrderId String
  assetId     String
  createdAt   DateTime  @default(now())
  asset       Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@id([workOrderId, assetId])
  @@index([workOrderId])
  @@index([assetId])
}

model WorkOrderProductUsage {
  id          String           @id @default(uuid())
  workOrderId String
  productId   String
  quantity    Int
  batchId     String?
  isApproved  Boolean          @default(false)
  approvedBy  String?
  approvedAt  DateTime?
  filledBy    String?
  modifiedBy  String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  batch       StockBatch?      @relation(fields: [batchId], references: [id])
  product     InventoryProduct @relation(fields: [productId], references: [id])
  workOrder   WorkOrder        @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([productId])
  @@index([isApproved])
}

model DeactivatedDevice {
  id                 String           @id @default(uuid())
  workOrderId        String
  productId          String
  quantity           Int
  batchId            String?
  isWorkingCondition Boolean          @default(false)
  checkedBy          String?
  checkedAt          DateTime?
  transferredToStock Boolean          @default(false)
  transferredBy      String?
  transferredAt      DateTime?
  stockTransactionId String?
  notes              String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  product            InventoryProduct @relation(fields: [productId], references: [id])
  workOrder          WorkOrder        @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([productId])
  @@index([isWorkingCondition])
  @@index([transferredToStock])
}

model WorkOrderNotification {
  id          String    @id @default(uuid())
  workOrderId String
  employeeId  String
  notifiedAt  DateTime?
  readAt      DateTime?
  createdAt   DateTime  @default(now())
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@unique([workOrderId, employeeId])
  @@index([workOrderId])
  @@index([employeeId])
  @@index([readAt])
}

model WorkOrderActivityLog {
  id              String    @id @default(uuid())
  workOrderId     String
  performedById   String?
  performedByName String?
  action          String
  category        String
  title           String
  description     String
  metadata        Json?
  createdAt       DateTime  @default(now())
  performedBy     Employee? @relation(fields: [performedById], references: [id])
  workOrder       WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([performedById])
  @@index([category])
  @@index([action])
  @@index([createdAt])
}

model User {
  id                String     @id @default(uuid())
  email             String     @unique
  passwordHash      String
  role              UserRole   @default(TECHNICIAN)
  isActive          Boolean    @default(true)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  isSuperAdmin      Boolean    @default(false)
  employee              Employee?
  incidentsReported     Incident[]
  telephonyExtension    TelephonyExtension?
  assignedCallSessions  CallSession[]       @relation("UserAssignedCalls")
  callLegs              CallLeg[]           @relation("UserCallLegs")
  missedCalls           MissedCall[]        @relation("UserMissedCalls")
  assignedCallbacks     CallbackRequest[]   @relation("UserAssignedCallbacks")
  qualityReviews        QualityReview[]     @relation("UserQualityReviews")
  assignedClientChats   ClientChatConversation[] @relation("UserAssignedClientChats")
  clientChatMessages    ClientChatMessage[]      @relation("UserClientChatMessages")

  @@index([email])
  @@index([isActive])
}

model Employee {
  id                       String                    @id @default(uuid())
  firstName                String
  lastName                 String
  email                    String                    @unique
  phone                    String?
  avatar                   String?
  birthday                 DateTime?
  employeeId               String                    @unique
  extensionNumber          String?
  jobTitle                 String?
  status                   EmployeeStatus            @default(ACTIVE)
  userId                   String?                   @unique
  positionId               String?
  departmentId             String?
  roleId                   String?
  managerId                String?
  address                  String?
  city                     String?
  country                  String?
  emergencyContact         String?
  emergencyPhone           String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  createdConversations     Conversation[]            @relation("ConversationCreator")
  conversationParticipants ConversationParticipant[]
  managedDepartments       Department?               @relation("DepartmentHead")
  department               Department?               @relation(fields: [departmentId], references: [id])
  manager                  Employee?                 @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates             Employee[]                @relation("ManagerSubordinates")
  position                 Position?                 @relation(fields: [positionId], references: [id])
  role                     Role?                     @relation(fields: [roleId], references: [id])
  user                     User?                     @relation(fields: [userId], references: [id])
  permissions              EmployeePermission[]
  createdLeads             Lead[]                    @relation("LeadCreatedBy")
  responsibleLeads         Lead[]                    @relation("LeadResponsible")
  leadActivities           LeadActivity[]
  leadAppointments         LeadAppointment[]
  leadNotes                LeadNote[]
  leadProposals            LeadProposal[]
  leadReminders            LeadReminder[]
  leadStageChanges         LeadStageHistory[]
  sentMessages             Message[]                 @relation("MessageSender")
  messageReactions         MessageReaction[]
  notificationLogs         NotificationLog[]
  approvedSalesPlans       SalesPlan[]               @relation("SalesPlanApprovedBy")
  createdSalesPlans        SalesPlan[]               @relation("SalesPlanCreatedBy")
  salesPlans               SalesPlan[]
  workOrderActivityLogs    WorkOrderActivityLog[]
  workOrderAssignments     WorkOrderAssignment[]
  workOrderNotifications   WorkOrderNotification[]

  @@index([status])
  @@index([email])
  @@index([employeeId])
  @@index([positionId])
  @@index([departmentId])
  @@index([roleId])
  @@index([managerId])
}

model Department {
  id                    String                 @id @default(uuid())
  name                  String
  code                  String                 @unique
  description           String?
  parentId              String?
  headId                String?                @unique
  isActive              Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  nameKa                String?
  head                  Employee?              @relation("DepartmentHead", fields: [headId], references: [id])
  parent                Department?            @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children              Department[]           @relation("DepartmentHierarchy")
  departmentPermissions DepartmentPermission[]
  departmentRoles       DepartmentRole[]
  employees             Employee[]
  positions             Position[]

  @@index([parentId])
  @@index([code])
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  code        String           @unique
  description String?
  level       Int?
  legacyRole  UserRole?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  departments DepartmentRole[]
  employees   Employee[]
  permissions RolePermission[]

  @@index([code])
  @@index([legacyRole])
}

model Permission {
  id                    String                 @id @default(uuid())
  resource              String
  action                String
  description           String?
  category              PermissionCategory     @default(GENERAL)
  createdAt             DateTime               @default(now())
  departmentPermissions DepartmentPermission[]
  employeePermissions   EmployeePermission[]
  roleGroupPermissions  RoleGroupPermission[]
  rolePermissions       RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([category])
}

model RoleGroup {
  id          String                @id @default(uuid())
  name        String                @unique
  code        String                @unique
  description String?
  isActive    Boolean               @default(true)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  positions   Position[]
  permissions RoleGroupPermission[]

  @@index([code])
}

model Position {
  id                           String                            @id @default(uuid())
  name                         String                            @unique
  code                         String                            @unique
  description                  String?
  level                        Int?
  roleGroupId                  String
  departmentId                 String?
  isActive                     Boolean                           @default(true)
  createdAt                    DateTime                          @default(now())
  updatedAt                    DateTime                          @updatedAt
  nameKa                       String?
  employees                    Employee[]
  department                   Department?                       @relation(fields: [departmentId], references: [id])
  roleGroup                    RoleGroup                         @relation(fields: [roleGroupId], references: [id])
  settings                     PositionSetting[]
  salesPipelineConfigPositions SalesPipelineConfigPosition[]
  salesPipelinePermissions     SalesPipelinePermissionPosition[]
  workflowSteps                WorkflowStepPosition[]

  @@index([code])
  @@index([roleGroupId])
  @@index([departmentId])
  @@index([level])
}

model PositionSetting {
  id          String    @id @default(uuid())
  key         String    @unique
  positionId  String?
  value       String?
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  position    Position? @relation(fields: [positionId], references: [id])

  @@index([key])
  @@index([positionId])
}

model WorkflowStep {
  id                String                 @id @default(uuid())
  stepKey           String                 @unique
  stepName          String
  description       String?
  stepOrder         Int                    @default(0)
  workOrderTypes    Json?
  triggerStatus     String?
  condition         String?
  requiredAction    String?
  isActive          Boolean                @default(true)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  assignedPositions WorkflowStepPosition[]

  @@index([stepOrder])
  @@index([triggerStatus])
  @@index([isActive])
}

model WorkflowStepPosition {
  id                String       @id @default(uuid())
  workflowStepId    String
  positionId        String
  isPrimaryAssignee Boolean      @default(true)
  notificationType  String       @default("TASK")
  createdAt         DateTime     @default(now())
  position          Position     @relation(fields: [positionId], references: [id], onDelete: Cascade)
  workflowStep      WorkflowStep @relation(fields: [workflowStepId], references: [id], onDelete: Cascade)

  @@unique([workflowStepId, positionId])
  @@index([workflowStepId])
  @@index([positionId])
}

model WorkflowTrigger {
  id            String                  @id @default(uuid())
  name          String
  workOrderType String?
  triggerType   WorkflowTriggerType
  condition     Json
  isActive      Boolean                 @default(true)
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  actions       WorkflowTriggerAction[]
  logs          WorkflowTriggerLog[]

  @@index([triggerType])
  @@index([workOrderType])
  @@index([isActive])
}

model WorkflowTriggerAction {
  id                String             @id @default(uuid())
  triggerId         String
  actionType        WorkflowActionType
  targetType        String
  targetPositionIds Json?
  templateCode      String?
  customSubject     String?
  customBody        String?
  sortOrder         Int                @default(0)
  isActive          Boolean            @default(true)
  trigger           WorkflowTrigger    @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@index([triggerId])
}

model WorkflowTriggerLog {
  id          String          @id @default(uuid())
  triggerId   String
  workOrderId String
  firedAt     DateTime        @default(now())
  trigger     WorkflowTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@unique([triggerId, workOrderId])
  @@index([triggerId])
  @@index([workOrderId])
}

model RoleGroupPermission {
  roleGroupId  String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  roleGroup    RoleGroup  @relation(fields: [roleGroupId], references: [id], onDelete: Cascade)

  @@id([roleGroupId, permissionId])
  @@index([roleGroupId])
  @@index([permissionId])
}

model RolePermission {
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model DepartmentPermission {
  departmentId String
  permissionId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([departmentId, permissionId])
  @@index([departmentId])
  @@index([permissionId])
}

model DepartmentRole {
  departmentId String
  roleId       String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([departmentId, roleId])
  @@index([departmentId])
  @@index([roleId])
}

model EmployeePermission {
  employeeId   String
  permissionId String
  type         PermissionOverride @default(GRANT)
  employee     Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  permission   Permission         @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([employeeId, permissionId])
  @@index([employeeId])
  @@index([permissionId])
}

/// *
///  * DEV/TEST ONLY:
///  * generate "core-like" external IDs when core system is not connected yet.
///  * Also used for ADMIN manual creation (fallback if core is down).
///  * WARNING: When CORE_INTEGRATION_ENABLED=true, seed nextId above core's max
///  * to avoid collisions with real core IDs.
model ExternalIdCounter {
  entity    String   @id
  nextId    Int
  updatedAt DateTime @updatedAt
}

/// Idempotency inbox for core-integration webhook events.
/// Prevents duplicate processing of the same event.
model SyncEvent {
  id           String    @id @default(uuid())
  source       String
  eventId      String    @unique
  entityType   String
  entityCoreId Int?
  receivedAt   DateTime  @default(now())
  processedAt  DateTime?
  status       String    @default("RECEIVED")
  error        String?
  payload      Json?

  @@index([status])
  @@index([entityType, entityCoreId])
  @@index([receivedAt])
}

model AuditLog {
  id         String      @id @default(uuid())
  action     AuditAction
  entity     AuditEntity
  entityKey  String
  actorId    String?
  actorEmail String?
  ip         String?
  userAgent  String?
  payload    Json?
  createdAt  DateTime    @default(now())

  @@index([entity, entityKey])
  @@index([actorId])
  @@index([createdAt])
}

model Incident {
  id             String           @id @default(uuid())
  incidentNumber String           @unique
  buildingId     String
  clientId       String?
  contactMethod  ContactMethod
  incidentType   String
  priority       IncidentPriority
  status         IncidentStatus   @default(CREATED)
  description    String
  reportedById   String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  building       Building         @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  client         Client?          @relation(fields: [clientId], references: [id])
  reportedBy     User?            @relation(fields: [reportedById], references: [id])
  incidentAssets IncidentAsset[]

  @@index([buildingId])
  @@index([clientId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([incidentType])
  @@index([incidentNumber])
}

model IncidentAsset {
  incidentId String
  assetId    String
  asset      Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@id([incidentId, assetId])
  @@index([assetId])
}

model InventoryProduct {
  id                 String                  @id @default(uuid())
  sku                String                  @unique
  name               String
  description        String?
  category           ProductCategory
  unit               ProductUnit             @default(PIECE)
  lowStockThreshold  Int                     @default(10)
  currentStock       Int                     @default(0)
  isActive           Boolean                 @default(true)
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  deactivatedDevices DeactivatedDevice[]
  purchaseOrderItems PurchaseOrderItem[]
  stockBatches       StockBatch[]
  stockTransactions  StockTransaction[]
  workOrderUsages    WorkOrderProductUsage[]

  @@index([sku])
  @@index([category])
  @@index([currentStock])
}

model PurchaseOrder {
  id            String              @id @default(uuid())
  poNumber      String              @unique
  supplierName  String
  supplierEmail String?
  status        PurchaseOrderStatus @default(DRAFT)
  orderDate     DateTime?
  expectedDate  DateTime?
  receivedDate  DateTime?
  totalAmount   Decimal             @default(0) @db.Decimal(12, 2)
  notes         String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  items         PurchaseOrderItem[]

  @@index([status])
  @@index([orderDate])
}

model PurchaseOrderItem {
  id              String           @id @default(uuid())
  purchaseOrderId String
  productId       String
  quantity        Int
  purchasePrice   Decimal          @db.Decimal(10, 2)
  subtotal        Decimal          @db.Decimal(12, 2)
  sellPrice       Decimal          @db.Decimal(10, 2)
  product         InventoryProduct @relation(fields: [productId], references: [id])
  purchaseOrder   PurchaseOrder    @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  stockBatch      StockBatch?

  @@index([purchaseOrderId])
  @@index([productId])
}

model StockBatch {
  id                  String                  @id @default(uuid())
  productId           String
  purchaseOrderItemId String                  @unique
  initialQuantity     Int
  remainingQuantity   Int
  purchasePrice       Decimal                 @db.Decimal(10, 2)
  receivedDate        DateTime                @default(now())
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  sellPrice           Decimal                 @db.Decimal(10, 2)
  product             InventoryProduct        @relation(fields: [productId], references: [id], onDelete: Cascade)
  purchaseOrderItem   PurchaseOrderItem       @relation(fields: [purchaseOrderItemId], references: [id])
  transactions        StockTransaction[]
  workOrderUsages     WorkOrderProductUsage[]

  @@index([productId])
  @@index([receivedDate])
  @@index([remainingQuantity])
}

model StockTransaction {
  id               String               @id @default(uuid())
  productId        String
  batchId          String?
  type             StockTransactionType
  quantity         Int
  workOrderId      String?
  referenceId      String?
  performedBy      String?
  performedByEmail String?
  notes            String?
  balanceBefore    Int
  balanceAfter     Int
  createdAt        DateTime             @default(now())
  batch            StockBatch?          @relation(fields: [batchId], references: [id])
  product          InventoryProduct     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([type])
  @@index([workOrderId])
  @@index([createdAt])
  @@index([productId, createdAt])
}

model SystemListCategory {
  id             String           @id @default(uuid())
  code           String           @unique
  name           String
  description    String?
  tableName      String?
  fieldName      String?
  isUserEditable Boolean          @default(true)
  sortOrder      Int              @default(0)
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  nameKa         String?
  items          SystemListItem[]

  @@index([code])
  @@index([isActive])
  @@index([sortOrder])
}

model SystemListItem {
  id              String             @id @default(uuid())
  categoryId      String
  value           String
  displayName     String
  description     String?
  colorHex        String?
  icon            String?
  sortOrder       Int                @default(0)
  isDefault       Boolean            @default(false)
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  displayNameKa   String?
  isSystemManaged Boolean            @default(false)
  category        SystemListCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, value])
  @@index([categoryId])
  @@index([isActive])
  @@index([sortOrder])
}

model Translation {
  id        String   @id @default(uuid())
  key       String   @unique
  en        String
  ka        String?
  context   String?
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([context])
}

model LeadStage {
  id                 String             @id @default(uuid())
  code               String             @unique
  name               String
  nameKa             String
  sortOrder          Int                @unique
  color              String?
  requiredFields     Json?
  allowedActions     Json?
  autoSkipConditions Json?
  isActive           Boolean            @default(true)
  isTerminal         Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  leads              Lead[]
  stageHistoryFrom   LeadStageHistory[] @relation("StageHistoryFrom")
  stageHistoryTo     LeadStageHistory[] @relation("StageHistoryTo")

  @@index([sortOrder])
  @@index([isActive])
}

model LeadSource {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameKa      String
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  leads       Lead[]

  @@index([isActive])
  @@index([sortOrder])
}

model Lead {
  id                      String             @id @default(uuid())
  leadNumber              Int                @unique @default(autoincrement())
  stageId                 String
  status                  LeadStatus         @default(ACTIVE)
  isLocked                Boolean            @default(false)
  lockedAt                DateTime?
  lockedBy                String?
  name                    String
  representative          String?
  primaryPhone            String
  contactPersons          Json?
  associationName         String?
  sourceId                String?
  city                    String
  address                 String
  floorsCount             Int                @default(0)
  entrancesCount          Int                @default(0)
  apartmentsPerFloor      Int                @default(0)
  elevatorsCount          Int                @default(0)
  entranceDoorsCount      Int                @default(0)
  responsibleEmployeeId   String?
  wonAt                   DateTime?
  lostAt                  DateTime?
  lostReason              String?
  submittedForApprovalAt  DateTime?
  submittedForApprovalBy  String?
  approvalNotes           String?
  approvedAt              DateTime?
  approvedBy              String?
  totalOneTimePrice       Decimal?           @db.Decimal(12, 2)
  totalMonthlyPrice       Decimal?           @db.Decimal(12, 2)
  createdById             String?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  createdByName           String?
  responsibleEmployeeName String?
  createdBy               Employee?          @relation("LeadCreatedBy", fields: [createdById], references: [id])
  responsibleEmployee     Employee?          @relation("LeadResponsible", fields: [responsibleEmployeeId], references: [id])
  source                  LeadSource?        @relation(fields: [sourceId], references: [id])
  stage                   LeadStage          @relation(fields: [stageId], references: [id])
  activities              LeadActivity[]
  appointments            LeadAppointment[]
  notes                   LeadNote[]
  proposals               LeadProposal[]
  reminders               LeadReminder[]
  services                LeadService[]
  stageHistory            LeadStageHistory[]

  @@index([stageId])
  @@index([status])
  @@index([responsibleEmployeeId])
  @@index([createdById])
  @@index([sourceId])
  @@index([city])
  @@index([isLocked])
  @@index([createdAt])
  @@index([leadNumber])
}

model SalesServiceCategory {
  id          String         @id @default(uuid())
  code        String         @unique
  name        String
  nameKa      String
  description String?
  sortOrder   Int            @default(0)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  services    SalesService[]

  @@index([isActive])
  @@index([sortOrder])
}

model SalesService {
  id           String                @id @default(uuid())
  code         String                @unique
  name         String
  nameKa       String
  description  String?
  monthlyPrice Decimal?              @db.Decimal(10, 2)
  oneTimePrice Decimal?              @db.Decimal(10, 2)
  parameters   Json?
  pricingRules Json?
  categoryId   String?
  sortOrder    Int                   @default(0)
  isActive     Boolean               @default(true)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  leadServices LeadService[]
  planTargets  SalesPlanTarget[]
  category     SalesServiceCategory? @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([isActive])
  @@index([sortOrder])
}

model LeadService {
  id           String       @id @default(uuid())
  leadId       String
  serviceId    String
  quantity     Int          @default(1)
  monthlyPrice Decimal?     @db.Decimal(10, 2)
  oneTimePrice Decimal?     @db.Decimal(10, 2)
  customParams Json?
  notes        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  lead         Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  service      SalesService @relation(fields: [serviceId], references: [id])

  @@unique([leadId, serviceId])
  @@index([leadId])
  @@index([serviceId])
}

model LeadActivity {
  id              String           @id @default(uuid())
  leadId          String
  activityType    LeadActivityType
  category        String
  action          String
  description     String
  previousValues  Json?
  newValues       Json?
  changedFields   Json?
  performedById   String?
  performedByName String?
  metadata        Json?
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime         @default(now())
  lead            Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  performedBy     Employee?        @relation(fields: [performedById], references: [id])

  @@index([leadId])
  @@index([activityType])
  @@index([category])
  @@index([performedById])
  @@index([createdAt])
}

model LeadNote {
  id            String    @id @default(uuid())
  leadId        String
  content       String
  isPinned      Boolean   @default(false)
  createdById   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdByName String?
  createdBy     Employee? @relation(fields: [createdById], references: [id])
  lead          Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([createdById])
  @@index([isPinned])
  @@index([createdAt])
}

model LeadReminder {
  id            String         @id @default(uuid())
  leadId        String
  title         String
  description   String?
  remindAt      DateTime
  status        ReminderStatus @default(PENDING)
  completedAt   DateTime?
  completedBy   String?
  createdById   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdByName String?
  createdBy     Employee?      @relation(fields: [createdById], references: [id])
  lead          Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([createdById])
  @@index([remindAt])
  @@index([status])
}

model LeadAppointment {
  id            String            @id @default(uuid())
  leadId        String
  title         String
  description   String?
  location      String?
  startTime     DateTime
  endTime       DateTime?
  status        AppointmentStatus @default(SCHEDULED)
  outcome       String?
  completedAt   DateTime?
  createdById   String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  createdByName String?
  createdBy     Employee?         @relation(fields: [createdById], references: [id])
  lead          Lead              @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([createdById])
  @@index([startTime])
  @@index([status])
}

model LeadProposal {
  id                String    @id @default(uuid())
  leadId            String
  proposalNumber    String    @unique
  title             String
  description       String?
  servicesSnapshot  Json
  totalOneTimePrice Decimal   @db.Decimal(12, 2)
  totalMonthlyPrice Decimal   @db.Decimal(12, 2)
  documentUrl       String?
  isSent            Boolean   @default(false)
  sentAt            DateTime?
  isAccepted        Boolean   @default(false)
  acceptedAt        DateTime?
  createdById       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdByName     String?
  createdBy         Employee? @relation(fields: [createdById], references: [id])
  lead              Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([createdById])
  @@index([proposalNumber])
  @@index([createdAt])
}

model LeadStageHistory {
  id            String     @id @default(uuid())
  leadId        String
  fromStageId   String?
  toStageId     String
  reason        String?
  changedById   String?
  createdAt     DateTime   @default(now())
  changedByName String?
  changedBy     Employee?  @relation(fields: [changedById], references: [id])
  fromStage     LeadStage? @relation("StageHistoryFrom", fields: [fromStageId], references: [id])
  lead          Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  toStage       LeadStage  @relation("StageHistoryTo", fields: [toStageId], references: [id])

  @@index([leadId])
  @@index([fromStageId])
  @@index([toStageId])
  @@index([changedById])
  @@index([createdAt])
}

model SalesPlan {
  id                      String            @id @default(uuid())
  type                    SalesPlanType
  year                    Int
  month                   Int?
  quarter                 Int?
  name                    String?
  description             String?
  employeeId              String?
  targetRevenue           Decimal?          @db.Decimal(12, 2)
  targetLeadConversions   Int?
  achievedRevenue         Decimal?          @db.Decimal(12, 2)
  achievedLeadConversions Int?
  status                  SalesPlanStatus   @default(DRAFT)
  createdById             String?
  approvedById            String?
  approvedAt              DateTime?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  createdByName           String?
  approvedBy              Employee?         @relation("SalesPlanApprovedBy", fields: [approvedById], references: [id])
  createdBy               Employee?         @relation("SalesPlanCreatedBy", fields: [createdById], references: [id])
  employee                Employee?         @relation(fields: [employeeId], references: [id])
  targets                 SalesPlanTarget[]

  @@unique([type, year, month, employeeId])
  @@unique([type, year, quarter, employeeId])
  @@index([employeeId])
  @@index([type])
  @@index([year])
  @@index([status])
  @@index([createdById])
}

model SalesPlanTarget {
  id               String       @id @default(uuid())
  planId           String
  serviceId        String
  targetQuantity   Int
  targetRevenue    Decimal?     @db.Decimal(10, 2)
  achievedQuantity Int          @default(0)
  achievedRevenue  Decimal?     @db.Decimal(10, 2)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  plan             SalesPlan    @relation(fields: [planId], references: [id], onDelete: Cascade)
  service          SalesService @relation(fields: [serviceId], references: [id])

  @@unique([planId, serviceId])
  @@index([planId])
  @@index([serviceId])
}

model SalesPipelineConfig {
  id                String                        @id @default(uuid())
  key               String                        @unique
  description       String?
  createdAt         DateTime                      @default(now())
  updatedAt         DateTime                      @updatedAt
  isActive          Boolean                       @default(true)
  name              String?
  stepOrder         Int?
  assignedPositions SalesPipelineConfigPosition[]

  @@index([key])
  @@index([isActive])
}

model SalesPipelineConfigPosition {
  id                String              @id @default(uuid())
  configId          String
  positionId        String
  isPrimaryAssignee Boolean             @default(false)
  createdAt         DateTime            @default(now())
  config            SalesPipelineConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  position          Position            @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@unique([configId, positionId])
  @@index([configId])
  @@index([positionId])
}

model SalesPipelinePermission {
  id            String                            @id @default(uuid())
  permissionKey String                            @unique
  name          String
  description   String?
  isActive      Boolean                           @default(true)
  createdAt     DateTime                          @default(now())
  updatedAt     DateTime                          @updatedAt
  positions     SalesPipelinePermissionPosition[]

  @@index([permissionKey])
  @@index([isActive])
}

model SalesPipelinePermissionPosition {
  id           String                  @id @default(uuid())
  permissionId String
  positionId   String
  createdAt    DateTime                @default(now())
  permission   SalesPipelinePermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  position     Position                @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@unique([permissionId, positionId])
  @@index([permissionId])
  @@index([positionId])
}

model EmailConfig {
  id         String   @id @default(uuid())
  smtpHost   String   @default("")
  smtpPort   Int      @default(587)
  smtpSecure Boolean  @default(false)
  smtpUser   String   @default("")
  smtpPass   String   @default("")
  imapHost   String   @default("")
  imapPort   Int      @default(993)
  imapSecure Boolean  @default(true)
  imapUser   String   @default("")
  imapPass   String   @default("")
  fromName   String   @default("")
  fromEmail  String   @default("")
  isActive   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model SmsConfig {
  id         String   @id @default(uuid())
  provider   String   @default("twilio")
  accountSid String   @default("")
  authToken  String   @default("")
  fromNumber String   @default("")
  isActive   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model NotificationTemplate {
  id        String           @id @default(uuid())
  name      String
  code      String           @unique
  type      NotificationType
  subject   String?
  body      String
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([type])
  @@index([isActive])
}

model NotificationLog {
  id           String           @id @default(uuid())
  type         NotificationType
  recipientId  String
  templateId   String?
  subject      String?
  body         String
  status       String           @default("PENDING")
  errorMessage String?
  sentAt       DateTime?
  createdAt    DateTime         @default(now())
  recipient    Employee         @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Conversation {
  id              String                    @id @default(uuid())
  type            ConversationType
  name            String?
  avatarUrl       String?
  lastMessageAt   DateTime?
  lastMessageText String?
  createdById     String
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  createdBy       Employee                  @relation("ConversationCreator", fields: [createdById], references: [id], onDelete: Cascade)
  participants    ConversationParticipant[]
  messages        Message[]

  @@index([lastMessageAt(sort: Desc)])
  @@index([type])
  @@index([createdById])
}

model ConversationParticipant {
  id             String                      @id @default(uuid())
  conversationId String
  employeeId     String
  role           ConversationParticipantRole @default(MEMBER)
  joinedAt       DateTime                    @default(now())
  lastReadAt     DateTime?
  mutedUntil     DateTime?
  isArchived     Boolean                     @default(false)
  conversation   Conversation                @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  employee       Employee                    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([conversationId, employeeId])
  @@index([employeeId, isArchived])
  @@index([conversationId])
}

model Message {
  id             String              @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  type           MessageType         @default(TEXT)
  replyToId      String?
  isEdited       Boolean             @default(false)
  isDeleted      Boolean             @default(false)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  conversation   Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  replyTo        Message?            @relation("MessageReplies", fields: [replyToId], references: [id])
  replies        Message[]           @relation("MessageReplies")
  sender         Employee            @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  attachments    MessageAttachment[]
  reactions      MessageReaction[]

  @@index([conversationId, createdAt(sort: Desc)])
  @@index([senderId])
  @@index([replyToId])
}

model MessageReaction {
  id         String   @id @default(uuid())
  messageId  String
  employeeId String
  emoji      String
  createdAt  DateTime @default(now())
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, employeeId, emoji])
  @@index([messageId])
}

model MessageAttachment {
  id        String   @id @default(uuid())
  messageId String
  url       String
  fileName  String
  fileSize  Int
  mimeType  String
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

// ──────────────────────────────────────────────
// Telephony / Call Center
// ──────────────────────────────────────────────

model TelephonyExtension {
  id          String   @id @default(uuid())
  crmUserId   String   @unique
  extension   String   @unique
  displayName String
  isOperator  Boolean  @default(true)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [crmUserId], references: [id], onDelete: Cascade)

  @@index([isActive])
}

model TelephonyQueue {
  id                String        @id @default(uuid())
  name              String        @unique
  strategy          QueueStrategy @default(RRMEMORY)
  isAfterHoursQueue Boolean       @default(false)
  worktimeConfig    Json?
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  callSessions      CallSession[]
  missedCalls       MissedCall[]

  @@index([isActive])
}

model CallSession {
  id                String           @id @default(uuid())
  linkedId          String           @unique
  uniqueId          String?
  direction         CallDirection
  did               String?
  callerNumber      String
  calleeNumber      String?
  queueId           String?
  assignedUserId    String?
  assignedExtension String?
  startAt           DateTime
  answerAt          DateTime?
  endAt             DateTime?
  disposition       CallDisposition?
  hangupCause       String?
  recordingStatus   RecordingStatus  @default(PENDING)
  createdAt         DateTime         @default(now())
  queue             TelephonyQueue?  @relation(fields: [queueId], references: [id])
  assignedUser      User?            @relation("UserAssignedCalls", fields: [assignedUserId], references: [id])
  callLegs          CallLeg[]
  callEvents        CallEvent[]
  callMetrics       CallMetrics?
  missedCall        MissedCall?
  recordings        Recording[]
  qualityReview     QualityReview?

  @@index([startAt])
  @@index([queueId])
  @@index([assignedUserId])
  @@index([disposition])
  @@index([callerNumber])
  @@index([queueId, startAt])
  @@index([assignedUserId, startAt])
  @@index([createdAt])
}

model CallLeg {
  id            String           @id @default(uuid())
  callSessionId String
  type          CallLegType
  userId        String?
  extension     String?
  startAt       DateTime
  answerAt      DateTime?
  endAt         DateTime?
  disposition   CallDisposition?
  createdAt     DateTime         @default(now())
  callSession   CallSession      @relation(fields: [callSessionId], references: [id], onDelete: Cascade)
  user          User?            @relation("UserCallLegs", fields: [userId], references: [id])

  @@index([callSessionId])
  @@index([userId])
  @@index([type])
  @@index([startAt])
}

model CallEvent {
  id             String       @id @default(uuid())
  callSessionId  String?
  eventType      String
  ts             DateTime
  payload        Json?
  source         String       @default("asterisk")
  idempotencyKey String       @unique
  createdAt      DateTime     @default(now())
  callSession    CallSession? @relation(fields: [callSessionId], references: [id], onDelete: SetNull)

  @@index([callSessionId])
  @@index([eventType])
  @@index([createdAt])
}

model CallMetrics {
  id                   String      @id @default(uuid())
  callSessionId        String      @unique
  waitSeconds          Float       @default(0)
  ringSeconds          Float       @default(0)
  talkSeconds          Float       @default(0)
  holdSeconds          Float       @default(0)
  wrapupSeconds        Float       @default(0)
  transfersCount       Int         @default(0)
  abandonsAfterSeconds Float?
  firstResponseSeconds Float?
  isSlaMet             Boolean?
  slaThresholdSeconds  Int?
  callSession          CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)
}

model MissedCall {
  id              String            @id @default(uuid())
  callSessionId   String            @unique
  reason          MissedCallReason
  detectedAt      DateTime          @default(now())
  queueId         String?
  userId          String?
  callerNumber    String
  status          MissedCallStatus  @default(NEW)
  notes           String?
  createdAt       DateTime          @default(now())
  callSession     CallSession       @relation(fields: [callSessionId], references: [id], onDelete: Cascade)
  queue           TelephonyQueue?   @relation(fields: [queueId], references: [id])
  user            User?             @relation("UserMissedCalls", fields: [userId], references: [id])
  callbackRequest CallbackRequest?

  @@index([status])
  @@index([queueId])
  @@index([detectedAt])
  @@index([callerNumber])
  @@index([userId])
}

model CallbackRequest {
  id               String                @id @default(uuid())
  missedCallId     String                @unique
  status           CallbackRequestStatus @default(PENDING)
  scheduledAt      DateTime?
  assignedToUserId String?
  attemptsCount    Int                   @default(0)
  lastAttemptAt    DateTime?
  outcome          String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  missedCall       MissedCall            @relation(fields: [missedCallId], references: [id], onDelete: Cascade)
  assignedTo       User?                 @relation("UserAssignedCallbacks", fields: [assignedToUserId], references: [id])

  @@index([status])
  @@index([scheduledAt])
  @@index([assignedToUserId])
}

model Recording {
  id              String      @id @default(uuid())
  callSessionId   String
  provider        String      @default("asterisk")
  url             String?
  filePath        String?
  durationSeconds Int?
  availableAt     DateTime?
  createdAt       DateTime    @default(now())
  callSession     CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  @@index([callSessionId])
  @@index([createdAt])
}

model QualityReview {
  id             String              @id @default(uuid())
  callSessionId  String              @unique
  status         QualityReviewStatus @default(PENDING)
  summary        String?
  score          Int?
  flags          Json?
  tags           Json?
  transcriptRef  String?
  reviewerUserId String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  callSession    CallSession         @relation(fields: [callSessionId], references: [id], onDelete: Cascade)
  reviewer       User?               @relation("UserQualityReviews", fields: [reviewerUserId], references: [id])

  @@index([status])
  @@index([reviewerUserId])
  @@index([createdAt])
  @@index([score])
}

model QualityRubric {
  id          String   @id @default(uuid())
  name        String
  description String?
  weight      Int      @default(25)
  maxScore    Int      @default(100)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([sortOrder])
}

// ──────────────────────────────────────────────
// Client Chats (Unified Inbox)
// ──────────────────────────────────────────────

model ClientChatChannelAccount {
  id            String                   @id @default(uuid())
  type          ClientChatChannelType
  name          String
  status        ClientChatAccountStatus  @default(ACTIVE)
  metadata      Json                     @default("{}")
  createdAt     DateTime                 @default(now())
  conversations ClientChatConversation[]
  participants  ClientChatParticipant[]

  @@index([type])
}

model ClientChatConversation {
  id                     String                  @id @default(uuid())
  channelType            ClientChatChannelType
  channelAccountId       String
  externalConversationId String                  @unique
  assignedUserId         String?
  clientId               String?
  status                 ClientChatStatus        @default(OPEN)
  lastMessageAt          DateTime?
  createdAt              DateTime                @default(now())
  channelAccount         ClientChatChannelAccount @relation(fields: [channelAccountId], references: [id], onDelete: Cascade)
  assignedUser           User?                   @relation("UserAssignedClientChats", fields: [assignedUserId], references: [id], onDelete: SetNull)
  client                 Client?                 @relation("ClientChatConversations", fields: [clientId], references: [id], onDelete: SetNull)
  messages               ClientChatMessage[]

  @@index([lastMessageAt(sort: Desc)])
  @@index([assignedUserId])
  @@index([status])
  @@index([channelType])
}

model ClientChatParticipant {
  id              String                   @id @default(uuid())
  channelType     ClientChatChannelType
  channelAccountId String
  externalUserId  String                   @unique
  displayName     String
  phone           String?
  email           String?
  mappedClientId  String?
  metadata        Json                     @default("{}")
  createdAt       DateTime                 @default(now())
  channelAccount  ClientChatChannelAccount @relation(fields: [channelAccountId], references: [id], onDelete: Cascade)
  mappedClient    Client?                  @relation("ClientChatParticipants", fields: [mappedClientId], references: [id], onDelete: SetNull)
  messages        ClientChatMessage[]

  @@index([channelType])
  @@index([mappedClientId])
}

model ClientChatMessage {
  id                String                @id @default(uuid())
  conversationId    String
  participantId     String?
  senderUserId      String?
  direction         ClientChatDirection
  externalMessageId String                @unique
  text              String
  attachments       Json?
  sentAt            DateTime
  deliveryStatus    String?
  rawPayload        Json?
  createdAt         DateTime              @default(now())
  conversation      ClientChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  participant       ClientChatParticipant? @relation(fields: [participantId], references: [id], onDelete: SetNull)
  senderUser        User?                 @relation("UserClientChatMessages", fields: [senderUserId], references: [id], onDelete: SetNull)

  @@index([conversationId, sentAt(sort: Desc)])
  @@index([externalMessageId])
}

model ClientChatWebhookFailure {
  id          String                @id @default(uuid())
  channelType ClientChatChannelType
  error       String
  payloadMeta Json                  @default("{}")
  createdAt   DateTime              @default(now())

  @@index([channelType])
  @@index([createdAt(sort: Desc)])
}

enum DeviceStatus {
  ONLINE
  OFFLINE
  UNKNOWN
}

enum WorkOrderType {
  INSTALLATION
  DIAGNOSTIC
  RESEARCH
  DEACTIVATE
  REPAIR_CHANGE
  ACTIVATE
}

enum WorkOrderStatus {
  CREATED
  LINKED_TO_GROUP
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum UserRole {
  ADMIN
  CALL_CENTER
  TECHNICIAN
  WAREHOUSE
  MANAGER
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
}

enum WorkflowTriggerType {
  STATUS_CHANGE
  FIELD_CHANGE
  INACTIVITY
  DEADLINE_PROXIMITY
}

enum WorkflowActionType {
  SYSTEM_NOTIFICATION
  EMAIL
  SMS
}

enum PermissionCategory {
  GENERAL
  BUILDINGS
  CLIENTS
  INCIDENTS
  WORK_ORDERS
  INVENTORY
  EMPLOYEES
  REPORTS
  ADMIN
  SALES
  MESSENGER
  TELEPHONY
  CLIENT_CHATS
}

enum PermissionOverride {
  GRANT
  DENY
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

enum AuditEntity {
  BUILDING
  CLIENT
  ASSET
  WORK_ORDER
  USER
  INCIDENT
  LEAD
  SALES_SERVICE
  SALES_PLAN
  CALL_SESSION
}

enum IncidentStatus {
  CREATED
  IN_PROGRESS
  COMPLETED
  WORK_ORDER_INITIATED
}

enum IncidentPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ContactMethod {
  PHONE
  EMAIL
  IN_PERSON
  OTHER
}

enum ProductCategory {
  ROUTER
  CONTROLLER
  SENSOR
  CABLE
  ACCESSORY
  HARDWARE
  SOFTWARE
  OTHER
}

enum ProductUnit {
  PIECE
  METER
  KG
  BOX
  SET
}

enum PurchaseOrderStatus {
  DRAFT
  ORDERED
  SHIPPED
  RECEIVED
  CANCELLED
}

enum StockTransactionType {
  PURCHASE_IN
  WORK_ORDER_OUT
  ADJUSTMENT_IN
  ADJUSTMENT_OUT
  RETURN_IN
  DAMAGED_OUT
}

enum LeadStatus {
  ACTIVE
  WON
  LOST
}

enum LeadActivityType {
  LEAD_CREATED
  LEAD_UPDATED
  STAGE_CHANGED
  LEAD_ASSIGNED
  LEAD_LOCKED
  LEAD_UNLOCKED
  LEAD_APPROVED
  LEAD_CANCELLED
  NOTE_ADDED
  NOTE_UPDATED
  NOTE_DELETED
  REMINDER_CREATED
  REMINDER_UPDATED
  REMINDER_COMPLETED
  REMINDER_DELETED
  APPOINTMENT_SCHEDULED
  APPOINTMENT_UPDATED
  APPOINTMENT_COMPLETED
  APPOINTMENT_CANCELLED
  SERVICE_ADDED
  SERVICE_UPDATED
  SERVICE_REMOVED
  PROPOSAL_CREATED
  PROPOSAL_UPDATED
  VIEWED
}

enum SalesPlanType {
  MONTHLY
  QUARTERLY
  ANNUAL
}

enum SalesPlanStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum ReminderStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum NotificationType {
  EMAIL
  SMS
}

enum ConversationType {
  DIRECT
  GROUP
}

enum ConversationParticipantRole {
  MEMBER
  ADMIN
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

// ──────────────────────────────────────────────
// Telephony enums
// ──────────────────────────────────────────────

enum CallDirection {
  IN
  OUT
}

enum CallDisposition {
  ANSWERED
  MISSED
  ABANDONED
  BUSY
  FAILED
  NOANSWER
}

enum CallLegType {
  CUSTOMER
  AGENT
  TRANSFER
}

enum QueueStrategy {
  RRMEMORY
  FEWESTCALLS
  RANDOM
  RINGALL
  LINEAR
  WRANDOM
}

enum MissedCallReason {
  OUT_OF_HOURS
  ABANDONED
  NO_ANSWER
}

enum MissedCallStatus {
  NEW
  HANDLED
  IGNORED
}

enum CallbackRequestStatus {
  PENDING
  SCHEDULED
  ATTEMPTING
  DONE
  FAILED
  CANCELED
}

enum RecordingStatus {
  PENDING
  AVAILABLE
  FAILED
}

enum QualityReviewStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

// ──────────────────────────────────────────────
// Client Chats enums
// ──────────────────────────────────────────────

enum ClientChatChannelType {
  WEB
  VIBER
  FACEBOOK
}

enum ClientChatStatus {
  OPEN
  PENDING
  CLOSED
  SPAM
}

enum ClientChatDirection {
  IN
  OUT
}

enum ClientChatAccountStatus {
  ACTIVE
  INACTIVE
}
